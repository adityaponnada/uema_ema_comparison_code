---
title: "uema_ema_corr"
output: html_document
date: "2025-01-16"
---

## Import library
```{r}

library(dplyr)
library(reshape2)
library(ggplot2)
library(psych)
library(readr)
library(purrr)
library(tidyr)
library(ggrepel)
library(cowplot)
```

## Read EMA data
```{r}

ema_df <- read.csv("/Users/adityaponnada/Downloads/time_study_data/EMA_data.csv", sep = ",", header = TRUE)

```

## Read uEMA data
```{r}
# Set the path to folder
folder_path <- "/Users/adityaponnada/Downloads/time_study_data/uema_data"

# List all files matching the pattern B_*.csv
files <- list.files(path = folder_path, pattern = "watch_promptresponse_.*@timestudy_com\\.csv$", full.names = TRUE)

# Read and combine all CSV files
uema_df <- files %>%
  map_df(read_csv)


```

## Subset data frames
```{r}

keep_uema <- c("Participant_ID", "Question_X_ID", "Answer_Status", "Question_X_Text", "Question_X_Answer_Text")

uema_df <- uema_df[, keep_uema]

```

### Check distributions
```{r}

table(uema_df$Answer_Status)

table(uema_df$Question_X_ID)

```

### Check participant distribution
```{r}

n_distinct(uema_df$Participant_ID)

```

## Keep only completed responses
```{r}

uema_df <- subset(uema_df, Answer_Status %in% c("Completed", "CompletedThenDismissed", "PartiallyCompleted"))

```

### Reformat question ID
```{r}

uema_df$Question_X_ID <- sub("_.*", "", uema_df$Question_X_ID)


```

### Keep only relevant questions
```{r}

uema_questions <- c("tense", "stress", "sad", "routine", "relax", "nervous", "happy", "frust", "focus", "fatigue", "control")

uema_df <- subset(uema_df, Question_X_ID %in% uema_questions)

```

### Score responses
```{r}

uema_df <- uema_df %>%
  mutate(Answer_Score = case_when(
    Question_X_Answer_Text == "Yes" ~ 3,
    Question_X_Answer_Text == "Sort of" ~ 2,
    Question_X_Answer_Text == "No" ~ 1,
    TRUE ~ NA_real_  # This handles any other values not specified above
  ))

```

### Remove remaining NOT_ANS
```{r}

uema_df <- subset(uema_df, !is.na(uema_df$Answer_Score))

```


### Compute variance for each question
```{r}

uema_wide_df <- uema_df %>%
  group_by(Participant_ID, Question_X_ID) %>%
  summarise(Answer_Score_Var = var(Answer_Score, na.rm = TRUE)) %>%
  pivot_wider(names_from = Question_X_ID, values_from = Answer_Score_Var)

```

## EMA data prep - filter the relevant columns
```{r}

ema_df <- subset(ema_df, ema_df$Answer_Status %in% c("Completed", "PartiallyCompleted"))

```

### keep only selected columns
```{r}

keep_ema <- c("participant_id", "Answer_Status", "x01_sad", "x02_happy", "x03_fatigued", "x05_relaxed", "x06_tense", "x07_stressed"  , "x08_frustrated", "x09_nervous", "x10_focused", "x11_control", "x14_routine")

ema_df <- ema_df[, keep_ema]

```

### Rename columns
```{r}

colnames(ema_df) <- c("Participant_ID", "Answer_Status", "sad", "happy", "fatigue", "relax", "tense", "stress", "frust", "nervous", "focus", "control", "routine")

```

### Compute variance for each question
```{r}

ema_wide_df <- ema_df %>%
  group_by(Participant_ID) %>%
  summarise(across(c(sad, happy, fatigue, relax, tense, stress, frust, nervous, focus, control, routine), var, na.rm = TRUE))

```

## Plot uema and ema data in grids
```{r}

uema_plot_df <- uema_wide_df %>% 
  pivot_longer(cols = -Participant_ID, names_to = "variable", values_to = "value")

uema_var_plot <- ggplot(uema_plot_df, aes(x = value)) +
  geom_histogram(bins = 30, fill = "steelblue", color = "white") +
  facet_wrap(~ variable, scales = "free", ncol = 4) +
  theme_minimal() +
  xlim(0, 4) +
  labs(title = "Histograms of All uEMA construct variances",
       x = "Value",
       y = "Count")

```
### For EMA
```{r}



ema_plot_df <- ema_wide_df %>% 
  pivot_longer(cols = -Participant_ID, names_to = "variable", values_to = "value")

ema_var_plot <- ggplot(ema_plot_df, aes(x = value)) +
  geom_histogram(bins = 30, fill = "steelblue", color = "white") +
  facet_wrap(~ variable, scales = "free", ncol = 4) +
  theme_minimal() +
  xlim(0,4) +
  labs(title = "Histograms of All EMA construct variances",
       x = "Value",
       y = "Count")

```

## EMA score mapped to uEMA
First, get the list of columns
```{r}
ema_col_list <- c("sad", "happy", "fatigue", "relax", "tense", "stress", "frust", "nervous", "focus", "control", "routine")
```

Then apply the function

```{r}

ema_3p_df <- ema_df %>%
  mutate(across(ema_col_list, 
                ~ case_when(
                  . %in% c(4, 5) ~ 3,
                  . %in% c(2, 3) ~ 2,
                  . == 1 ~ 1,
                  TRUE ~ NA_real_
                )))

```

### Compute variance for each question
```{r}

ema_3p_wide_df <- ema_3p_df %>%
  group_by(Participant_ID) %>%
  summarise(across(c(sad, happy, fatigue, relax, tense, stress, frust, nervous, focus, control, routine), var, na.rm = TRUE))

```

### Plot ema 3p variance distribution
```{r}

ema_3p_plot_df <- ema_3p_wide_df %>% 
  pivot_longer(cols = -Participant_ID, names_to = "variable", values_to = "value")

ema_3p_var_plot <- ggplot(ema_3p_plot_df, aes(x = value)) +
  geom_histogram(bins = 30, fill = "steelblue", color = "white") +
  facet_wrap(~ variable, scales = "free", ncol = 4) +
  theme_minimal() +
  xlim(0,4) +
  labs(title = "Histograms of All EMA construct variances (3 point)",
       x = "Value",
       y = "Count")

```

## Rename columns for uEMA and EMA
We will rename each of the column name except for participant_ID to have a prefix of either uema_ or ema_
```{r}

column_rename <- function(df, prefix) {
  colnames(df)[-1] <- paste0(prefix, "_", colnames(df)[-1])
  return(df)
}

```

Now we apply the function
```{r}

uema_wide_df <- column_rename(uema_wide_df, "uema")

```

Now apply to EMA data
```{r}


ema_3p_wide_df <- column_rename(ema_3p_wide_df, "ema")

```

## Read the participant status data
```{r}

participant_status_dat_df <- read.csv("/Users/adityaponnada/Downloads/time_study_data/participant_status_tracking_v2.csv", sep = ",", header = TRUE)

participant_status_dat_df$Participant_ID <- paste0(participant_status_dat_df$Visualizer.ID, "@timestudy_com")

```

Get the daily report participant list from daily_report_subset
```{r}

final_participant_list <- unique(daily_report_subset$participant_ID)

```

### Filter the participant status data
```{r}

participant_status_dat_df <- subset(participant_status_dat_df, participant_status_dat_df$Participant_ID %in% final_participant_list)

```

### Only keep the Participant ID and the Participant Status column in the data frame
```{r}

participant_status_dat_df <- participant_status_dat_df[, c("Participant_ID", "Participant.Status")]

```

First, add @timestudy_com to participant ID in ema_3p_wide_df
```{r}
ema_3p_wide_df$Participant_ID <- paste0(ema_3p_wide_df$Participant_ID, "@timestudy_com")
```


### Filter uEMA and EMA data based on final participant list
```{r}

uema_wide_df <- subset(uema_wide_df, uema_wide_df$Participant_ID %in% final_participant_list)

ema_3p_wide_df <- subset(ema_3p_wide_df, ema_3p_wide_df$Participant_ID %in% final_participant_list)

```

### Find out the users who are in uEMA but not in ema data
```{r}

uema_not_in_ema <- setdiff(uema_wide_df$Participant_ID, ema_3p_wide_df$Participant_ID)

```

### Merge uEMA and EMA data by Participant ID.
But we will only keep the common participant_IDs in uema and EMA
```{r}

combined_df <- merge(uema_wide_df, ema_3p_wide_df, by = "Participant_ID")

```

Next, we also add the participant status column to this dataframe. We also ensure that the new column is the second column
```{r}

combined_df1 <- merge(combined_df, participant_status_dat_df, by = "Participant_ID")


```

### Next we compute the pearson correlation between uEMA and EMA data for each construct
We then save it in a dataframe with the construct name and the correlation value and p-value
```{r}

correlation_df <- data.frame()
correr <- function(df, construct) {
  cor_val <- cor.test(df[, c(paste0("uema_", construct))], df[, c(paste0("ema_", construct))], method="pearson")
  return(c(cor_val$estimate, cor_val$p.value))
}

```

Test the correlation for all the constructs and print them one by one.
```{r}

for (construct in c("sad", "happy", "fatigue", "relax", "tense", "stress", "frust", "nervous", "focus", "control", "routine")) {
  cor_val <- correr(combined_df1, construct)
  correlation_df <- rbind(correlation_df, data.frame(construct = construct, correlation = cor_val[[1]], p_value = cor_val[[2]]))
}

```

## Plot individual construct correlations
Here, we will plot each constructs scatterplots with the correlation value and p-value displayed on the plot.
```{r}

correlation_plot <- ggplot(correlation_df, aes(x = correlation, y = p_value, label = construct)) +
  geom_point() +
  geom_text_repel() +
  labs(title = "Correlation between uEMA and EMA constructs",
       x = "Correlation",
       y = "P-value")

```

In the next plot, we will use the combined_df1 dataframe to plot the scatterplots for each construct. For example, we will plot the scatterplot for sad construct where the x-axis is the uema_sad and the y-axis is the ema_sad. We will also display the correlation value and p-value on the plot.
```{r}

construct_plot <- function(df, construct) {
  plot_df <- df %>% select(paste0("uema_", construct), paste0("ema_", construct))
  plot_df <- plot_df[complete.cases(plot_df), ]
  cor_val <- cor.test(plot_df[,1], plot_df[,2], method="pearson")
  plot <- ggplot(plot_df, aes(x = plot_df[,1], y = plot_df[,2])) +
    geom_point() +
    geom_smooth(method = "lm", se = FALSE) +
    # geom_text(x = 1, y = 1, label = paste("Correlation:", round(cor_val$estimate, 2), "P-value:", round(cor_val$p.value, 2))) +
    labs(title = paste0(construct, " (r=", round(cor_val$estimate, 2), ")"),
         x = paste0("\u03BC", "EMA Variance"),
         y = "EMA Variance") +
    xlim(0, 1) +
    ylim(0, 1) +
    theme_bw() +
    theme(panel.background = element_rect(fill = "white"))
  return(plot)
}

```


Next, we will create a grid of all the 11 constructs and plot them side by side. We will create a grid of 3x4 plots.
```{r}

construct_plots <- list()
for (construct in c("sad", "happy", "fatigue", "relax", "tense", "stress", "frust", "nervous", "focus", "control", "routine")) {
  construct_plots[[construct]] <- construct_plot(combined_df1, construct)
}


```

Now we will arrange them in a 3X4 grid
```{r}

construct_plots_grid <- plot_grid(plotlist = construct_plots, ncol = 4, nrow = 3, rel_heights = c(1, 1, 1))


```

